<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Reminder App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }
        #main-container { transition: filter 0.3s; }
        .modal-open { filter: blur(4px); pointer-events: none; }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8); }
        }
        .pulsing-glow {
            animation: pulse-glow 2s infinite ease-in-out;
        }
    </style>
</head>
<body id="body" class="bg-slate-900 text-white flex items-center justify-center min-h-screen py-10">

    <!-- Main App Container -->
    <div id="main-container" class="p-4 sm:p-8 max-w-6xl w-full mx-auto">
        <div class="flex flex-col lg:flex-row lg:gap-16">

            <!-- Left Column -->
            <div class="lg:w-1/2 flex flex-col items-center">
                <!-- Header -->
                <header class="mb-8 text-center">
                    <h1 class="text-4xl sm:text-5xl font-bold text-cyan-400">Your Reminders</h1>
                    <p class="text-slate-400 mt-2 text-lg">Stay on track with custom alerts.</p>
                </header>

                <!-- Main Timer Display -->
                <div id="timer-container" class="bg-slate-800/50 rounded-full w-64 h-64 sm:w-80 sm:h-80 mx-auto flex flex-col items-center justify-center p-4 shadow-2xl border-4 border-slate-700 transition-all duration-500">
                    <div id="timer-display" class="text-6xl sm:text-7xl font-black text-white tracking-tighter">--:--</div>
                    <div id="status-message" class="text-xl text-center font-medium text-cyan-400 mt-2 h-14 px-4">Add or start a reminder</div>
                </div>

                <!-- Global Controls -->
                <div class="mt-10 flex justify-center items-center space-x-4">
                    <button id="start-pause-btn" class="bg-cyan-500 hover:bg-cyan-600 text-slate-900 font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200">Start All</button>
                    <button id="reset-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200">Reset All</button>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:w-1/2 mt-12 lg:mt-0">
                <!-- Reminders List -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">My List</h2>
                        <button id="add-reminder-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-200">+ Add New</button>
                    </div>
                    <div id="reminders-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="reminder-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-white">Add New Reminder</h2>
            <form id="reminder-form" class="space-y-4">
                <input type="hidden" id="reminder-id">
                <!-- Title -->
                <div>
                    <label for="reminder-title" class="block text-slate-400 mb-1">Title</label>
                    <input type="text" id="reminder-title" placeholder="e.g., Drink Water" class="w-full bg-slate-700 text-white p-3 rounded-lg border-2 border-slate-600 focus:outline-none focus:border-cyan-500" required>
                </div>
                <!-- Main Interval -->
                <fieldset class="border border-slate-600 p-3 rounded-lg">
                    <legend class="px-2 text-slate-400">Reminder Interval</legend>
                    <div class="flex gap-4">
                        <input type="number" id="reminder-hours" min="0" placeholder="H" class="w-full bg-slate-700 text-white p-2 rounded-lg text-center">
                        <input type="number" id="reminder-minutes" min="0" max="59" placeholder="M" class="w-full bg-slate-700 text-white p-2 rounded-lg text-center">
                        <input type="number" id="reminder-seconds" min="0" max="59" placeholder="S" class="w-full bg-slate-700 text-white p-2 rounded-lg text-center">
                    </div>
                </fieldset>
                <!-- Break Settings -->
                <fieldset class="border border-slate-600 p-3 rounded-lg">
                    <legend class="px-2 text-slate-400">Break Settings</legend>
                    <div class="space-y-3">
                         <div>
                            <label for="break-duration" class="block text-slate-400 mb-1">Break Duration (seconds)</label>
                            <input type="number" id="break-duration" min="0" placeholder="e.g., 20" class="w-full bg-slate-700 text-white p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="break-start-text" class="block text-slate-400 mb-1">Voice Prompt (Start)</label>
                            <input type="text" id="break-start-text" placeholder="e.g., Eye break start" class="w-full bg-slate-700 text-white p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="break-end-text" class="block text-slate-400 mb-1">Voice Prompt (End)</label>
                            <input type="text" id="break-end-text" placeholder="e.g., Break is over" class="w-full bg-slate-700 text-white p-3 rounded-lg">
                        </div>
                    </div>
                </fieldset>
                <!-- Buttons -->
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-full">Cancel</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-slate-900 font-bold py-3 px-6 rounded-full">Save Reminder</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // --- DOM ELEMENTS ---
    const mainContainer = document.getElementById('main-container');
    const body = document.getElementById('body');
    const timerContainer = document.getElementById('timer-container');
    const timerDisplay = document.getElementById('timer-display');
    const statusMessage = document.getElementById('status-message');
    const startPauseBtn = document.getElementById('start-pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const addReminderBtn = document.getElementById('add-reminder-btn');
    const remindersList = document.getElementById('reminders-list');
    const modal = document.getElementById('reminder-modal');
    const modalTitle = document.getElementById('modal-title');
    const reminderForm = document.getElementById('reminder-form');
    const cancelBtn = document.getElementById('cancel-btn');
    // Form Inputs
    const reminderIdInput = document.getElementById('reminder-id');
    const reminderTitleInput = document.getElementById('reminder-title');
    const reminderHoursInput = document.getElementById('reminder-hours');
    const reminderMinutesInput = document.getElementById('reminder-minutes');
    const reminderSecondsInput = document.getElementById('reminder-seconds');
    const breakDurationInput = document.getElementById('break-duration');
    const breakStartTextInput = document.getElementById('break-start-text');
    const breakEndTextInput = document.getElementById('break-end-text');

    // --- STATE ---
    let reminders = [];
    let timerInterval = null;
    let synth = window.speechSynthesis;
    let femaleVoice = null;

    // --- LOCAL STORAGE FUNCTIONS ---
    /**
     * Saves the current reminders array and a timestamp to localStorage.
     */
    function saveReminders() {
        const stateToSave = {
            reminders: reminders,
            savedAt: Date.now()
        };
        localStorage.setItem('customRemindersApp', JSON.stringify(stateToSave));
    }

    /**
     * Loads reminders from localStorage, adjusts time for elapsed period, and restores state.
     */
    function loadReminders() {
        const savedStateJSON = localStorage.getItem('customRemindersApp');
        if (savedStateJSON) {
            const savedState = JSON.parse(savedStateJSON);
            const savedReminders = savedState.reminders;
            const savedAt = savedState.savedAt;
            const timeElapsed = Math.round((Date.now() - savedAt) / 1000);

            reminders = savedReminders.map(r => {
                if (!r.isPaused) {
                    // Subtract the time elapsed while the page was closed/reloading
                    r.timeLeft -= timeElapsed;
                }
                // Reset any active breaks to avoid strange states on reload
                r.isBreakActive = false;
                r.breakTimeLeft = 0;

                // Handle cases where the timer expired while the page was closed
                if (r.timeLeft <= 0 && !r.isPaused) {
                    // For simplicity, we'll just restart its cycle.
                    r.timeLeft = r.duration; 
                }
                return r;
            });

        } else {
            // Initialize with a default reminder if none are saved
            reminders.push({
                id: Date.now(),
                title: "20-20-20 Eye Break",
                duration: 20 * 60,
                timeLeft: 20 * 60,
                breakDuration: 20,
                breakStartText: "Eye break start",
                breakEndText: "Break is over",
                isBreakActive: false,
                breakTimeLeft: 0,
                isPaused: true
            });
        }
    }

    // --- CORE LOGIC ---
    function timerLoop() {
        let isAnyBreakActive = false;

        reminders.forEach(reminder => {
            if (reminder.isPaused) return; 

            if (reminder.isBreakActive) {
                isAnyBreakActive = true;
                reminder.breakTimeLeft--;
                if (reminder.breakTimeLeft <= 5 && reminder.breakTimeLeft > 0) {
                    speakText(String(reminder.breakTimeLeft));
                } else if (reminder.breakTimeLeft > 5) {
                    playTickSound();
                }

                if (reminder.breakTimeLeft <= 0) {
                    reminder.isBreakActive = false;
                    speakText(reminder.breakEndText);
                    reminder.timeLeft = reminder.duration;
                }
            } else {
                reminder.timeLeft--;
                if (reminder.timeLeft <= 0) {
                    reminder.isBreakActive = true;
                    reminder.breakTimeLeft = reminder.breakDuration;
                    speakText(reminder.breakStartText);
                    showNotification(reminder.title, "Time for your scheduled break.");
                    isAnyBreakActive = true;
                }
            }
        });

        if (isAnyBreakActive) {
            body.classList.add('bg-green-900');
            timerContainer.classList.add('border-green-500', 'pulsing-glow');
        } else {
            body.classList.remove('bg-green-900');
            timerContainer.classList.remove('border-green-500', 'pulsing-glow');
        }

        updateMainDisplay();
        updateIndividualDisplays();
        updateGlobalButtonState();
    }

    function updateMainDisplay() {
        const runningReminders = reminders.filter(r => !r.isPaused);
        if (runningReminders.length === 0) {
            timerDisplay.textContent = "--:--";
            statusMessage.textContent = "Add or start a reminder";
            document.title = "Custom Reminder App";
            return;
        }

        let activeBreakReminder = runningReminders.find(r => r.isBreakActive);
        let displayReminder, isBreak;

        if (activeBreakReminder) {
            displayReminder = activeBreakReminder;
            isBreak = true;
        } else {
            displayReminder = runningReminders.reduce((next, current) => current.timeLeft < next.timeLeft ? current : next, runningReminders[0]);
            isBreak = false;
        }

        const timeToShow = isBreak ? displayReminder.breakTimeLeft : displayReminder.timeLeft;
        const minutes = Math.floor(timeToShow / 60);
        const seconds = timeToShow % 60;
        const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        timerDisplay.textContent = formattedTime;
        statusMessage.textContent = isBreak ? `${displayReminder.title} Break` : `Next up: ${displayReminder.title}`;

        if (isBreak) {
            document.title = (timeToShow % 2 === 0) ? `!! BREAK !! (${formattedTime})` : `Look Away üëÄ (${formattedTime})`;
        } else {
            document.title = `${formattedTime} - ${displayReminder.title}`;
        }
    }

    // --- UI & RENDER FUNCTIONS ---
    function updateIndividualDisplays() {
        reminders.forEach(r => {
            const timerEl = remindersList.querySelector(`.individual-timer[data-id="${r.id}"]`);
            if (timerEl) {
                const timeToShow = r.isBreakActive ? r.breakTimeLeft : r.timeLeft;
                const minutes = Math.floor(timeToShow / 60);
                const seconds = timeToShow % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerEl.textContent = formattedTime;
            }
        });
    }

    function renderReminders() {
        remindersList.innerHTML = '';
        if (reminders.length === 0) {
            remindersList.innerHTML = `<p class="text-slate-500 text-center py-4">No reminders yet. Add one to get started!</p>`;
        } else {
            reminders.forEach(r => {
                const h = Math.floor(r.duration / 3600);
                const m = Math.floor((r.duration % 3600) / 60);
                const s = r.duration % 60;
                const durationText = `${h}h ${m}m ${s}s`;
                
                const timeToShow = r.isBreakActive ? r.breakTimeLeft : r.timeLeft;
                const minutes = Math.floor(timeToShow / 60);
                const seconds = timeToShow % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                const reminderEl = document.createElement('div');
                reminderEl.className = 'bg-slate-800 p-4 rounded-lg flex justify-between items-center';
                reminderEl.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${r.title}</p>
                        <p class="text-sm text-slate-400">Every ${durationText} / Break: ${r.breakDuration}s</p>
                    </div>
                    <div class="text-right">
                        <p class="individual-timer text-2xl text-cyan-300 font-mono mb-1" data-id="${r.id}">${formattedTime}</p>
                        <div class="flex items-center gap-2">
                            <button class="toggle-pause-btn bg-gray-500/80 hover:bg-gray-500 p-2 rounded-full w-10 h-10 flex items-center justify-center" data-id="${r.id}">${r.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}</button>
                            <button class="edit-btn bg-blue-500/80 hover:bg-blue-500 p-2 rounded-full w-10 h-10 flex items-center justify-center" data-id="${r.id}">‚úèÔ∏è</button>
                            <button class="delete-btn bg-red-500/80 hover:bg-red-500 p-2 rounded-full w-10 h-10 flex items-center justify-center" data-id="${r.id}">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                remindersList.appendChild(reminderEl);
            });
        }
        updateMainDisplay();
        updateGlobalButtonState();
    }

    // --- MODAL HANDLING ---
    function openModal(mode = 'add', id = null) {
        reminderForm.reset();
        if (mode === 'edit') {
            const r = reminders.find(r => r.id === id);
            if (!r) return;
            modalTitle.textContent = 'Edit Reminder';
            reminderIdInput.value = r.id;
            reminderTitleInput.value = r.title;
            reminderHoursInput.value = Math.floor(r.duration / 3600);
            reminderMinutesInput.value = Math.floor((r.duration % 3600) / 60);
            reminderSecondsInput.value = r.duration % 60;
            breakDurationInput.value = r.breakDuration;
            breakStartTextInput.value = r.breakStartText;
            breakEndTextInput.value = r.breakEndText;
        } else {
            modalTitle.textContent = 'Add New Reminder';
            reminderIdInput.value = '';
        }
        modal.classList.remove('hidden');
        mainContainer.classList.add('modal-open');
    }

    function closeModal() {
        modal.classList.add('hidden');
        mainContainer.classList.remove('modal-open');
    }

    // --- CRUD OPERATIONS ---
    function handleFormSubmit(e) {
        e.preventDefault();
        const id = reminderIdInput.value;
        const title = reminderTitleInput.value;
        const h = parseInt(reminderHoursInput.value) || 0;
        const m = parseInt(reminderMinutesInput.value) || 0;
        const s = parseInt(reminderSecondsInput.value) || 0;
        const duration = (h * 3600) + (m * 60) + s;
        
        const breakDuration = parseInt(breakDurationInput.value) || 0;
        const breakStartText = breakStartTextInput.value || "Break start";
        const breakEndText = breakEndTextInput.value || "Break over";

        if (duration <= 0) {
            console.error("Please set a duration greater than 0.");
            return;
        }

        const reminderData = { title, duration, timeLeft: duration, breakDuration, breakStartText, breakEndText, isBreakActive: false, breakTimeLeft: 0, isPaused: true };

        if (id) { // Update
            const index = reminders.findIndex(r => r.id == id);
            if (index > -1) reminders[index] = { ...reminders[index], ...reminderData };
        } else { // Add
            reminders.push({ id: Date.now(), ...reminderData });
        }
        saveReminders();
        renderReminders();
        closeModal();
    }
    
    function deleteReminder(id) {
        reminders = reminders.filter(r => r.id !== id);
        saveReminders();
        renderReminders();
    }

    // --- AUDIO & NOTIFICATIONS ---
    function loadVoices() {
        const voices = synth.getVoices();
        femaleVoice = voices.find(v => v.lang.includes('en') && v.name.includes('Female')) || voices.find(v => v.lang.includes('en-US')) || voices[0];
    }

    function speakText(text) {
        if (!femaleVoice || !text) return;
        synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.voice = femaleVoice;
        utterThis.pitch = 1;
        utterThis.rate = 0.9;
        synth.speak(utterThis);
    }

    function playTickSound() {
        if (Tone.context.state !== 'running') Tone.context.resume();
        const tickSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.2, sustain: 0 } }).toDestination();
        tickSynth.triggerAttackRelease("C6", "32n");
    }

    function showNotification(title, bodyText) {
        if (Notification.permission === 'granted') {
            new Notification(title, { body: bodyText, icon: 'https://placehold.co/192x192/06b6d4/FFFFFF?text=üîî' });
        }
    }

    // --- GLOBAL CONTROLS ---
    function toggleAll() {
        const areAllPaused = reminders.every(r => r.isPaused);
        reminders.forEach(r => r.isPaused = !areAllPaused); 
        saveReminders();
        renderReminders();
        
        if (areAllPaused) {
            if (reminders.length > 0 && !timerInterval) {
                timerInterval = setInterval(timerLoop, 1000);
            }
            if (Tone.context.state !== 'running') Tone.start();
            if (synth.state === 'suspended') synth.resume();
        }
    }

    function updateGlobalButtonState() {
        if (reminders.length === 0) {
            startPauseBtn.textContent = "Start All";
            return;
        }
        const areAllPaused = reminders.every(r => r.isPaused);
        const areAllRunning = reminders.every(r => !r.isPaused);

        if (areAllPaused) {
            startPauseBtn.textContent = "Start All";
        } else if (areAllRunning) {
            startPauseBtn.textContent = "Pause All";
        } else {
            startPauseBtn.textContent = "Resume All";
        }
    }

    function resetAll() {
        reminders.forEach(r => {
            r.timeLeft = r.duration;
            r.isBreakActive = false;
            r.breakTimeLeft = 0;
        });
        saveReminders();
        body.classList.remove('bg-green-900');
        timerContainer.classList.remove('border-green-500', 'pulsing-glow');
        renderReminders();
    }

    // --- EVENT LISTENERS ---
    startPauseBtn.addEventListener('click', toggleAll);
    resetBtn.addEventListener('click', resetAll);
    addReminderBtn.addEventListener('click', () => openModal('add'));
    cancelBtn.addEventListener('click', closeModal);
    reminderForm.addEventListener('submit', handleFormSubmit);

    remindersList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const toggleBtn = e.target.closest('.toggle-pause-btn');
        
        if (toggleBtn) {
            const id = parseInt(toggleBtn.dataset.id);
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.isPaused = !reminder.isPaused;
                if (!reminder.isPaused && !timerInterval) {
                     timerInterval = setInterval(timerLoop, 1000);
                }
                saveReminders();
                renderReminders();
            }
        }
        if (editBtn) {
            openModal('edit', parseInt(editBtn.dataset.id));
        }
        if (deleteBtn) {
            deleteReminder(parseInt(deleteBtn.dataset.id));
        }
    });

    // --- INITIALIZATION ---
    function initialize() {
        loadReminders();
        renderReminders();
        Notification.requestPermission();
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        // MODIFIED: Save state automatically when the user leaves the page.
        window.addEventListener('beforeunload', saveReminders);
        
        // NEW: Automatically start the timer loop if any reminders were running before the refresh.
        if (reminders.some(r => !r.isPaused)) {
            if (!timerInterval) {
                timerInterval = setInterval(timerLoop, 1000);
            }
            if (Tone.context.state !== 'running') Tone.start();
            if (synth.state === 'suspended') synth.resume();
        }
    }

    initialize();
    </script>
</body>
</html>
